name: CI/CD Pipeline For Luigi Scheduler
on:
  push:
    branches:
      - main
      - prod
  pull_request:
    branches:
      - prod
    types: [opened, synchronize]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  BASE_IMAGE_NAME: ${{ github.repository }}

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      luigi-scheduler: ${{ steps.changes.outputs.luigi-scheduler }}
      shared: ${{ steps.changes.outputs.shared }}
      should-test: ${{ steps.should-test.outputs.result }}
      should-deploy: ${{ steps.should-deploy.outputs.result }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v2
        id: changes
        with:
          filters: |
            luigi-scheduler:
              - 'docker/luigi/**'
              - 'docker/luigi/requirements.txt'
              - 'docker/luigi/Dockerfile'
              - 'src/**'
            shared:
              - 'shared/**'
              - '.github/workflows/**'
              - 'pyproject.toml'
              - 'setup.py'
      - name: Determine if should test
        id: should-test
        run: |
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            # Always test in PRs if files changed
            if [[ "${{ steps.changes.outputs.luigi-scheduler }}" == "true" || "${{ steps.changes.outputs.shared }}" == "true" ]]; then
              echo "result=true" >> $GITHUB_OUTPUT
            else
              echo "result=false" >> $GITHUB_OUTPUT
            fi
          else
            # Skip tests on push to prod (merge), we'll use PR artifacts
            echo "result=false" >> $GITHUB_OUTPUT
          fi

      - name: Determine if should deploy
        id: should-deploy
        run: |
          if [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == "refs/heads/prod" ]]; then
            echo "result=true" >> $GITHUB_OUTPUT
          else
            echo "result=false" >> $GITHUB_OUTPUT
          fi

  luigi-scheduler-quality:
    runs-on: ubuntu-latest
    name: Luigi Scheduler - Code Quality
    if: needs.detect-changes.outputs.should-test == 'true'
    needs: detect-changes
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install uv
        uses: astral-sh/setup-uv@v3
        with:
          version: "latest"

      - name: Test dependency resolution
        run: |
          echo "Testing if dependencies can be resolved..."
          uv venv test-env
          if uv pip install -r docker/luigi/requirements.txt --dry-run; then
            echo "✅ Dependencies can be resolved"
          else
            echo "❌ Dependency resolution failed - using fallback audit"
            # Create a fallback requirements file for audit
            cat > requirements-fallback.txt << EOF
          luigi==3.6.0
          psycopg2-binary==2.9.10
          sqlalchemy==2.0.42
          python-dotenv==1.1.1
          pandas>=2.2.3
          numpy>=1.24.4
          scikit-learn>=1.4.0
          mlflow==3.1.4
          EOF
          fi

      - name: Luigi Scheduler Dependency Scan
        uses: pypa/gh-action-pip-audit@v1.0.8
        with:
          inputs: ${{ hashFiles('requirements-fallback.txt') && 'requirements-fallback.txt' || 'docker/luigi/requirements.txt' }}
          continue-on-error: true

      - name: Luigi Scheduler Dockerfile Lint
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: docker/luigi/Dockerfile

  luigi-scheduler-test:
    runs-on: ubuntu-latest
    name: Luigi Scheduler - Tests
    if: needs.detect-changes.outputs.should-test == 'true'
    needs: luigi-scheduler-quality
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install uv
        uses: astral-sh/setup-uv@v3
        with:
          version: "latest"

      - name: Cache uv dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/uv
          key: uv-${{ runner.os }}-${{ hashFiles('docker/luigi/requirements.txt') }}
          restore-keys: |
            uv-${{ runner.os }}-

      - name: Create virtual environment
        run: uv venv .venv

      - name: Install test dependencies
        run: |
          uv pip install pytest pytest-cov

      - name: Install project dependencies
        run: |
          if [ -f docker/luigi/requirements.txt ]; then 
          echo "Installing from docker/luigi/requirements.txt"
          uv pip install -r docker/luigi/requirements.txt
          else
          echo "Warning: requirements.txt not found"
          exit 1
          fi

      - name: Verify installation
        run: |
          uv pip list

      - name: Run Luigi Scheduler Tests
        run: |
          cd src
          source ../.venv/bin/activate
          pytest --cov=. --cov-report=xml --cov-report=term --verbose
          mv coverage.xml ../luigi-scheduler-coverage.xml

      - name: Upload coverage
        uses: codecov/codecov-action@v3
        with:
          file: ./luigi-scheduler-coverage.xml
          flags: luigi-scheduler

  luigi-scheduler-build:
    runs-on: ubuntu-latest
    name: Luigi Scheduler - Build
    if: needs.detect-changes.outputs.should-test == 'true'
    needs: luigi-scheduler-test
    permissions:
      contents: read
      packages: write
    outputs:
      image-digest: ${{ steps.build.outputs.digest }}
      image-name: ${{ env.REGISTRY }}/${{ env.BASE_IMAGE_NAME }}/luigi-scheduler
      image-tag: ${{ steps.extract-tag.outputs.tag }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.BASE_IMAGE_NAME }}/luigi-scheduler
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=sha
            type=raw,value=latest-tested,enable={{is_default_branch}}

      - name: Extract deployment tag
        id: extract-tag
        run: |
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            # Use PR number for PR builds
            TAG="${{ env.REGISTRY }}/${{ env.BASE_IMAGE_NAME }}/luigi-scheduler:pr-${{ github.event.number }}"
          else
            # Use SHA for branch builds
            TAG="${{ env.REGISTRY }}/${{ env.BASE_IMAGE_NAME }}/luigi-scheduler:sha-${{ github.sha }}"
          fi
          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          echo "Deployment tag: ${TAG}"

      - name: Update Entrypoint File
        run: |
          # Create a temporary entrypoint.sh with environment variables
          echo "LUIGI_DB_HOST=${{ secrets.LUIGI_DB_HOST || 'postgres' }}" >> .env.scheduler
          echo "LUIGI_DB_PORT=${{ secrets.LUIGI_DB_PORT || '5432' }}" >> .env.scheduler
          echo "LUIGI_DB_NAME=${{ secrets.LUIGI_DB_NAME || 'luigidb' }}" >> .env.scheduler
          echo "LUIGI_DB_USER=${{ secrets.LUIGI_DB_USER || 'luigi' }}" >> .env.scheduler
          echo "LUIGI_DB_PASSWORD=${{ secrets.LUIGI_DB_PASSWORD || 'luigi123' }}" >> .env.scheduler

          export $(cat .env.scheduler | xargs) && envsubst < docker/luigi/entrypoint.sh > docker/luigi/entrypoint.sh.tmp && mv docker/luigi/entrypoint.sh.tmp docker/luigi/entrypoint.sh


      - name: Build and push Luigi Scheduler
        id: build
        uses: docker/build-push-action@v5
        with:
          context: ./docker/luigi
          file: ./docker/luigi/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha,scope=luigi-scheduler
          cache-to: type=gha,mode=max,scope=luigi-scheduler

  sonarcloud-analysis:
    runs-on: ubuntu-latest
    name: SonarCloud Analysis
    needs: [ luigi-scheduler-test ]
    if: always() && needs.luigi-scheduler-test.result == 'success'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Download coverage reports
      - name: Download coverage reports
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: coverage-reports
          path: ./coverage/

      - name: SonarCloud Scan
        uses: SonarSource/sonarqube-scan-action@v5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  security-scan:
    runs-on: ubuntu-latest
    name: Security Scan
    needs: [ luigi-scheduler-build ]
    if: needs.detect-changes.outputs.should-test == 'true'
    permissions:
      contents: read
      security-events: write
      actions: read
      packages: read
    outputs:
      image-name: ${{ needs.luigi-scheduler-build.outputs.image-name }}
      image-digest: ${{ needs.luigi-scheduler-build.outputs.image-digest }}
      image-tag: ${{ needs.luigi-scheduler-build.outputs.image-tag }}
    strategy:
      matrix:
        service: [ luigi-scheduler ]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set image reference
        id: image-ref
        run: |
          # Use image digest for exact reference to the built image
          IMAGE_REF="${{ needs.luigi-scheduler-build.outputs.image-name }}@${{ needs.luigi-scheduler-build.outputs.image-digest }}"
          echo "image-ref=${IMAGE_REF}" >> $GITHUB_OUTPUT
          echo "Using image reference: ${IMAGE_REF}"

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ steps.image-ref.outputs.image-ref }}
          format: 'sarif'
          output: 'trivy-${{ matrix.service }}-results.sarif'
          skip-files: '/usr/local/bundle/gems/**'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'

      - name: Check if SARIF file exists
        id: check-sarif
        run: |
          if [ -f "trivy-${{ matrix.service }}-results.sarif" ]; then
            echo "sarif-exists=true" >> $GITHUB_OUTPUT
            echo "SARIF file found"
          else
            echo "sarif-exists=false" >> $GITHUB_OUTPUT
            echo "SARIF file not found"
          fi

      - name: Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v3
        if: always() && steps.check-sarif.outputs.sarif-exists == 'true'
        with:
          sarif_file: 'trivy-${{ matrix.service }}-results.sarif'
          category: 'trivy-${{ matrix.service }}'

  store-image-info:
    runs-on: ubuntu-latest
    name: Store Image Info
    if: needs.detect-changes.outputs.should-test == 'true'
    needs: [ security-scan ]
    steps:
      - name: Store image reference
        run: |
          echo "Image built and tested: ${{ needs.security-scan.outputs.image-name }}@${{ needs.security-scan.outputs.image-digest }}"
          echo "Tag: ${{ needs.security-scan.outputs.image-tag }}"

  deploy:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.should-deploy == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up SSH
        uses: webfactory/ssh-agent@v0.7.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Get latest tested image
        id: get-image
        run: |
          IMAGE_TAG="${{ env.REGISTRY }}/${{ env.BASE_IMAGE_NAME }}/luigi-scheduler:sha-${{ github.sha }}"

          echo "image-tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
          echo "Deploying image: ${IMAGE_TAG}"

      - name: Verify image exists
        run: |
          docker manifest inspect ${{ steps.get-image.outputs.image-tag }} > /dev/null
          echo "✅ Image verified: ${{ steps.get-image.outputs.image-tag }}"

      - name: Set up environment variables from secrets
        run: |
          echo "Setting up environment variables from secrets"
          echo "LUIGI_DB_HOST=${{ secrets.LUIGI_DB_HOST || 'postgres' }}" >> .env.scheduler
          echo "LUIGI_DB_PORT=${{ secrets.LUIGI_DB_PORT || '5432' }}" >> .env.scheduler
          echo "LUIGI_DB_NAME=${{ secrets.LUIGI_DB_NAME || 'luigidb' }}" >> .env.scheduler
          echo "LUIGI_DB_USER=${{ secrets.LUIGI_DB_USER || 'luigi' }}" >> .env.scheduler
          echo "LUIGI_DB_PASSWORD=${{ secrets.LUIGI_DB_PASSWORD || 'luigi123' }}" >> .env.scheduler
          echo "SCHEDULER_IMAGE_NAME=${{ steps.image-ref.outputs.image-ref }}" >> .env.scheduler
          echo "WRAPPER_IMAGE_NAME=alpine:latest" >> .env.scheduler

      - name: Copy files to VPS
        run: |
          # Add VPS host to known hosts
          mkdir -p ~/.ssh
          ssh-keyscan ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

          # Create necessary directories on VPS
          ssh ${{ secrets.VPS_USERNAME }}@${{ secrets.VPS_HOST }} "mkdir -p ~/model-service/src ~/model-service/config ~/model-service/data ~/model-service/.dvc"

          # Copy files to VPS
          scp -r docker-compose.yml .env.scheduler ${{ secrets.VPS_USERNAME }}@${{ secrets.VPS_HOST }}:~/model-service/
          scp -r src/* ${{ secrets.VPS_USERNAME }}@${{ secrets.VPS_HOST }}:~/model-service/src
          scp -r config/* ${{ secrets.VPS_USERNAME }}@${{ secrets.VPS_HOST }}:~/model-service/config
          scp -r data/* ${{ secrets.VPS_USERNAME }}@${{ secrets.VPS_HOST }}:~/model-service/data
          scp -r .dvc/* ${{ secrets.VPS_USERNAME }}@${{ secrets.VPS_HOST }}:~/model-service/.dvc

      - name: Process Luigi Config
        run: |
          ssh ${{ secrets.VPS_USERNAME }}@${{ secrets.VPS_HOST }} "cd ~/model-service && export $(cat .env.scheduler | xargs) && envsubst < config/luigi.cfg > config/luigi.cfg.tmp && mv config/luigi.cfg.tmp config/luigi.cfg"

      - name: Update Image
        run: |
          ssh ${{ secrets.VPS_USERNAME }}@${{ secrets.VPS_HOST }} "cd ~/model-service && export $(cat .env.scheduler | xargs) && envsubst < docker-compose.yml > docker-compose.scheduler.yml"

      - name: Deploy Base Services on VPS
        run: |
          echo "Deploying service scheduler on VPS"
          ssh ${{ secrets.VPS_USERNAME }}@${{ secrets.VPS_HOST }} "cd ~/model-service && docker compose -f docker-compose.scheduler.yml --env-file .env.scheduler up -d luigi"
